<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/estilos.css">
    <title>Dashboard - Sistema de Carros</title>
</head>
<body>
    <!-- ===== ENCABEZADO DEL DASHBOARD ===== -->
    <header class="dashboard-header">
        <h1>üöó Sistema de Gesti√≥n de Carros</h1>
        <div class="user-info">
            <!-- Mostramos el nombre del usuario que inici√≥ sesi√≥n -->
            Bienvenido, <strong><%= user.username %></strong>
            <!-- Enlace para cerrar sesi√≥n -->
            <a href="/logout" class="btn-logout">Cerrar Sesi√≥n</a>
        </div>
    </header>

    <!-- ===== CONTENIDO PRINCIPAL ===== -->
    <main class="dashboard-main">
        <!-- SECCI√ìN: FORMULARIO PARA AGREGAR CARRO -->
        <section class="add-car-form">
            <h2>‚ûï Agregar Nuevo Carro</h2>
            <!-- Formulario que env√≠a los datos a la ruta /add-car -->
            <form action="/add-car" method="post">
                <div class="form-row">
                    <div class="form-group">
                        <label for="marca">Marca:</label>
                        <input type="text" id="marca" name="marca" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="modelo">Modelo:</label>
                        <input type="text" id="modelo" name="modelo" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="a√±o">A√±o:</label>
                        <!-- Input num√©rico con l√≠mites para a√±os v√°lidos -->
                        <input type="number" id="a√±o" name="a√±o" min="1900" max="2030" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="color">Color:</label>
                        <input type="text" id="color" name="color">
                    </div>
                    
                    <div class="form-group">
                        <label for="precio">Precio ($):</label>
                        <!-- Input para decimales con paso de 0.01 -->
                        <input type="number" id="precio" name="precio" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn-add">Agregar Carro</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- SECCI√ìN: TABLA DE CARROS EXISTENTES -->
        <section class="cars-table">
            <h2>üìä Inventario de Carros</h2>
            
            <!-- Verificamos si hay carros en la base de datos -->
            <% if (carros.length > 0) { %>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>A√±o</th>
                            <th>Color</th>
                            <th>Precio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Iteramos sobre cada carro usando EJS -->
                        <% carros.forEach(carro => { %>
                            <tr>
                                <td><%= carro.id %></td>
                                <td><%= carro.marca %></td>
                                <td><%= carro.modelo %></td>
                                <td><%= carro.a√±o %></td>
                                <td><%= carro.color %></td>
                                <!-- Formateamos el precio con separadores de miles -->
                                <td>$<%= carro.precio.toLocaleString() %></td>
                                <td class="actions">
                                    <!-- Bot√≥n de editar con todos los datos del carro en atributos data -->
                                    <button class="btn-edit edit-btn" 
                                        data-id="<%= carro.id %>"
                                        data-marca="<%= carro.marca %>"
                                        data-modelo="<%= carro.modelo %>"
                                        data-a√±o="<%= carro.a√±o %>"
                                        data-color="<%= carro.color %>"
                                        data-precio="<%= carro.precio %>">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <!-- Enlace para eliminar con confirmaci√≥n JavaScript -->
                                    <a href="/delete-car/<%= carro.id %>" class="btn-delete" onclick="return confirm('¬øEst√°s seguro de eliminar este carro?')">üóëÔ∏è Eliminar</a>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } else { %>
                <!-- Mensaje que se muestra cuando no hay carros -->
                <div class="no-data">
                    <p>No hay carros en el inventario. ¬°Agrega el primero!</p>
                </div>
            <% } %>
        </section>
    </main>

    <!-- ===== VENTANA EMERGENTE PARA EDITAR CARROS ===== -->
    <!-- Esta ventana est√° oculta por defecto (display: none) -->
    <div id="editModal" class="modal">
        <div class="modal-content">
           <div class="modal-header">
                <h2>‚úèÔ∏è Editar Carro</h2>
                <!-- Bot√≥n X para cerrar la ventana -->
                <button type="button" class="close-modal">&times;</button>
            </div>
            <!-- Formulario de edici√≥n que se env√≠a din√°micamente -->
            <form id="editForm" method="post">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editMarca">Marca:</label>
                        <input type="text" id="editMarca" name="marca" required>
                    </div>
                    <div class="form-group">
                        <label for="editModelo">Modelo:</label>
                        <input type="text" id="editModelo" name="modelo" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editA√±o">A√±o:</label>
                        <input type="number" id="editA√±o" name="a√±o" min="1900" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="editColor">Color:</label>
                        <input type="text" id="editColor" name="color">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editPrecio">Precio ($):</label>
                        <input type="number" id="editPrecio" name="precio" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-update">‚úÖ Actualizar Carro</button>
                    <button type="button" class="btn-cancel close-modal">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

<!-- ===== JAVASCRIPT PARA LA VENTANA EMERGENTE ===== -->
<script>
    // Variables principales para controlar la ventana emergente
    const editModal = document.getElementById('editModal');        // La ventana completa
    const closeButtons = document.querySelectorAll('.close-modal'); // Botones de cerrar (X y Cancelar)
    const editForm = document.getElementById('editForm');          // Formulario de edici√≥n

    // Funci√≥n para abrir la ventana emergente con los datos del carro seleccionado
    function openEditModal(button) {
        // Obtenemos todos los datos del carro desde los atributos data del bot√≥n
        const id = button.getAttribute('data-id');
        const marca = button.getAttribute('data-marca');
        const modelo = button.getAttribute('data-modelo');
        const a√±o = button.getAttribute('data-a√±o');
        const color = button.getAttribute('data-color');
        const precio = button.getAttribute('data-precio');
        
        // Llenamos el formulario con los datos actuales del carro
        document.getElementById('editMarca').value = marca;
        document.getElementById('editModelo').value = modelo;
        document.getElementById('editA√±o').value = a√±o;
        document.getElementById('editColor').value = color;
        document.getElementById('editPrecio').value = precio;
        
        // Guardamos los datos originales para poder comparar despu√©s si hubo cambios
        editForm.setAttribute('data-original-marca', marca);
        editForm.setAttribute('data-original-modelo', modelo);
        editForm.setAttribute('data-original-a√±o', a√±o);
        editForm.setAttribute('data-original-color', color);
        editForm.setAttribute('data-original-precio', precio);
        
        // Actualizamos la URL del formulario con el ID del carro a editar
        editForm.action = `/update-car/${id}`;
        
        // Mostramos la ventana emergente
        editModal.style.display = 'block';
    }

    // Funci√≥n para cerrar la ventana emergente
    function closeModal() {
        editModal.style.display = 'none';  // Ocultamos la ventana
        editForm.reset();                  // Limpiamos el formulario
    }

    // Configuramos los eventos para cerrar la ventana con los botones X y Cancelar
    closeButtons.forEach(button => {
        button.addEventListener('click', closeModal);
    });

    // Cerramos la ventana si el usuario hace clic fuera del contenido (en el fondo oscuro)
    window.addEventListener('click', (event) => {
        if (event.target === editModal) {
            closeModal();
        }
    });

    // Cerramos la ventana cuando el usuario presiona la tecla ESC
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && editModal.style.display === 'block') {
            closeModal();
        }
    });

    // Configuramos los eventos para los botones de "Editar" en la tabla
    document.addEventListener('DOMContentLoaded', function() {
        const editButtons = document.querySelectorAll('.edit-btn');
        
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                openEditModal(this);  // 'this' se refiere al bot√≥n que se clicke√≥
            });
        });
    });

    // Manejamos el env√≠o del formulario de edici√≥n
    editForm.addEventListener('submit', function(e) {
        e.preventDefault();  // Evitamos el env√≠o inmediato del formulario
        
        // Obtenemos los datos originales del carro (antes de editar)
        const originalMarca = this.getAttribute('data-original-marca');
        const originalModelo = this.getAttribute('data-original-modelo');
        const originalA√±o = this.getAttribute('data-original-a√±o');
        const originalColor = this.getAttribute('data-original-color');
        const originalPrecio = this.getAttribute('data-original-precio');
        
        // Obtenemos los nuevos datos (lo que el usuario escribi√≥ en el formulario)
        const nuevaMarca = document.getElementById('editMarca').value;
        const nuevoModelo = document.getElementById('editModelo').value;
        const nuevoA√±o = document.getElementById('editA√±o').value;
        const nuevoColor = document.getElementById('editColor').value;
        const nuevoPrecio = document.getElementById('editPrecio').value;
        
        // Verificamos campo por campo para detectar qu√© realmente cambi√≥
        const cambios = [];
        
        if (originalMarca !== nuevaMarca) {
            cambios.push(`Marca: "${originalMarca}" ‚Üí "${nuevaMarca}"`);
        }
        if (originalModelo !== nuevoModelo) {
            cambios.push(`Modelo: "${originalModelo}" ‚Üí "${nuevoModelo}"`);
        }
        if (originalA√±o !== nuevoA√±o) {
            cambios.push(`A√±o: ${originalA√±o} ‚Üí ${nuevoA√±o}`);
        }
        if (originalColor !== nuevoColor) {
            cambios.push(`Color: "${originalColor}" ‚Üí "${nuevoColor}"`);
        }
        if (originalPrecio !== nuevoPrecio) {
            cambios.push(`Precio: $${originalPrecio} ‚Üí $${nuevoPrecio}`);
        }
        
        // Si detectamos cambios, mostramos confirmaci√≥n al usuario
        if (cambios.length > 0) {
            const mensaje = "Se modificar√°n los siguientes campos:\n\n" + cambios.join('\n') + "\n\n¬øConfirmas los cambios?";
            
            if (confirm(mensaje)) {
                this.submit();  // Si confirma, enviamos el formulario
            }
            // Si cancela, no hacemos nada y la ventana sigue abierta
        } else {
            // Si no hay cambios, informamos al usuario y cerramos la ventana
            alert('No se detectaron cambios en los campos.');
            closeModal();
        }
    });
</script>
</body>
</html>